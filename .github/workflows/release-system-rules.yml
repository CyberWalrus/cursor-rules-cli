name: Auto-version System Rules

on:
  push:
    branches: [main]
    paths:
      - "system-rules/**"

permissions:
  contents: write

jobs:
  version-and-tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate CalVer version
        id: version
        run: |
          DATE=$(date -u +"%Y.%-m.%-d")
          # Получаем теги напрямую из удаленного репозитория и фильтруем по паттерну
          REMOTE_TAGS=$(git ls-remote --tags origin | grep "refs/tags/system-rules/v${DATE}\." | sed "s/.*refs\/tags\/system-rules\/v${DATE}\.//" | sed "s/\^{}//" | sort -n)

          if [ -z "$REMOTE_TAGS" ]; then
              # Если тегов нет, начинаем с 1
              INCREMENT=1
          else
              # Находим максимальный инкремент и увеличиваем на 1
              MAX_INCREMENT=$(echo "$REMOTE_TAGS" | tail -n 1)
              INCREMENT=$((MAX_INCREMENT + 1))
          fi

          VERSION="${DATE}.${INCREMENT}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

      - name: Create Git Tag
        run: |
          git tag system-rules/v${{ steps.version.outputs.version }}
          git push origin system-rules/v${{ steps.version.outputs.version }}

