name: Auto-version Prompts

on:
  push:
    branches: [main]
    paths:
      - ".cursor/**"

permissions:
  contents: write

jobs:
  version-and-tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate CalVer version
        id: version
        run: |
          DATE=$(date -u +"%Y.%-m.%-d")
          # Получаем теги напрямую из удаленного репозитория и фильтруем по паттерну
          REMOTE_TAGS=$(git ls-remote --tags origin | grep "refs/tags/prompts/v${DATE}\." | sed "s/.*refs\/tags\/prompts\/v${DATE}\.//" | sed "s/\^{}//" | sort -n)

          if [ -z "$REMOTE_TAGS" ]; then
              # Если тегов нет, начинаем с 1
              INCREMENT=1
          else
              # Находим максимальный инкремент и увеличиваем на 1
              MAX_INCREMENT=$(echo "$REMOTE_TAGS" | tail -n 1)
              INCREMENT=$((MAX_INCREMENT + 1))
          fi

          VERSION="${DATE}.${INCREMENT}"
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Generated version: ${VERSION}"

      - name: Update prompts-version.json
        run: |
          cat > .cursor/prompts-version.json <<EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "released": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "changelog": "Auto-generated release"
          }
          EOF
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add .cursor/prompts-version.json
          git commit -m "chore(prompts): auto-version ${{ steps.version.outputs.version }}" || exit 0
          git push

      - name: Create Git Tag
        run: |
          git tag prompts/v${{ steps.version.outputs.version }}
          git push origin prompts/v${{ steps.version.outputs.version }}
