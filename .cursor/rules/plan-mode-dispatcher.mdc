---
id: plan-mode-dispatcher
type: compact
alwaysApply: false
---

# Plan Mode Dispatcher

<plan_mode_dispatcher>

**‚ö†Ô∏è CRITICAL - ZERO EXCEPTIONS:**

Classification is MANDATORY for EVERY task. "Task is simple" or "faster without protocol" = WRONG REASONING. Task complexity and speed preferences are IRRELEVANT. NO shortcuts, NO bypassing, NO exceptions - EVER.

**ACTIVATION:** Run only when "Plan mode is active" in system_reminder; otherwise skip.

**NOTE:** Mode announcement handled by `.cursor/rules/01-chat-mode-router.mdc`.

**FIRST ACTION:** Classify activity type before ANY response. Skipping = plan aborts.

**BLOCKING GATE BEFORE create_plan**

PROHIBIT create_plan unless all checks pass:

[ ] Type classified
[ ] Type announced: "üìã [type] ‚Üí üìÑ .cursor/rules/[name].mdc ‚Üí Following as primary instructions"
[ ] Workflow read: read_file('.cursor/rules/[name].mdc') in same batch
[ ] Content received

IF any check fails ‚Üí abort current step, retry entire classification process (steps 1-8) max 3 times, then report error

**ZERO TOLERANCE ENFORCEMENT:**

‚ùå VIOLATION DETECTION: create_plan called without type announcement ‚Üí PROTOCOL FAILURE

‚ö†Ô∏è SELF-CHECK MANDATORY: "Did I announce type OR cannot list selected type?" YES ‚Üí STOP, execute classification (lines 40-54) NOW

**AFTER PLAN EXECUTION (CRITICAL):**

When user approves plan and execution starts:

1. **MANDATORY FIRST LINE (NO TOOLS BEFORE):** Output `[MODE_INITIALIZED: AGENT_MODE] ‚Üí üìÑ .cursor/rules/07-agent-mode-workflow.mdc ‚Üí Following as primary instructions (already loaded)`
2. Then execute todos - FORBIDDEN to skip step 1

**Classification Algorithm**

1. READ user request for codes ONLY
2. CHECK codes: `td*` ‚Üí instant match ‚Üí go to step 5
3. IF no code ‚Üí check file extensions ‚Üí match from table
4. IF no match ‚Üí analyze keywords and context ‚Üí select highest density
5. SELECT type ‚Üí IF tie ‚Üí first from Activity Types table
6. ANNOUNCE: `üìã [type] ‚Üí üìÑ .cursor/rules/[name].mdc ‚Üí Following as primary instructions`
7. READ: read_file('.cursor/rules/[name].mdc') in same batch
8. VERIFY: content received ‚Üí IF failed ‚Üí abort, retry read up to 3 times; after 3rd failure switch to DEFAULT (Code Development)
9. PROCEED: create_plan

IF no match at step 5 ‚Üí DEFAULT to Code Development

**ANTI-SHORTCUT:** "Task is obvious" = WRONG. Obviousness IRRELEVANT to protocol. Classification MANDATORY even for trivial tasks.

**Priority:** Codes > Extensions > Keywords > Context > Default (tie: use table row order - Prompt Engineering first)

**Language support:** Analyze requests in ANY language - detect intent patterns, not exact matches

**Activity Types**

| Activity | Codes | Key Triggers | File |
|:---|:---|:---|:---|
| Prompt Engineering | `tdprompt` | `.cursor/`, `.mdc`, "prompt", "rules", "AI behavior", "workflow", "dispatcher", "improve prompt", "rewrite prompt" | `.cursor/rules/prompt-workflow.mdc` |
| Code Development | `tdcode` | `.ts`, `.tsx`, `.js`, `.jsx`, "bug", "fix", "implement", "function", "refactor" | `.cursor/rules/code-workflow.mdc` |
| UI Development | `tdui` | "ui", "interface", "visual", "styles", "component", "layout", "design" | `.cursor/rules/ui-workflow.mdc` |
| AI Documentation | `tdaidoc` | "ai-docs", "package-ai-docs", "module-ai-docs", "module documentation", "YAML", "Di√°taxis", "update documentation" | `.cursor/rules/ai-docs-workflow.mdc` |
| Technical Critique | `tdcritic` | "critique", "review", "evaluate", "code review", "analysis" | `.cursor/rules/critique-workflow.mdc` |
| JIRA Task | `tdjira` | "JIRA task", "technical spec", "create task" | `.cursor/rules/jira-task-creator.mdc` |
| Auxiliary Dev | `tdaux` | "script", "deploy", "automation", "CI/CD", "config" | `.cursor/rules/auxiliary-code-workflow.mdc` |

**PRE-CREATE_PLAN BARRIER (mandatory verification):**

BEFORE calling create_plan tool, verify ALL:

- [ ] Type classified using algorithm (steps 1-5)
- [ ] Type announced: "üìã [type] ‚Üí üìÑ .cursor/rules/[name].mdc ‚Üí Following as primary instructions"
- [ ] Workflow file read: read_file('.cursor/rules/[name].mdc')
- [ ] Content received and confirmed

‚ùå ANY unchecked ‚Üí FORBIDDEN to call create_plan ‚Üí GO TO line 40

**Self-check question:** "Can I list which type I selected?" NO ‚Üí Classification skipped ‚Üí STOP

**FORBIDDEN:**

- create_plan before classification
- Questions before read_file
- Skip announcement

**Example:** `üìã Prompt Engineering ‚Üí üìÑ .cursor/rules/prompt-workflow.mdc ‚Üí Following as primary instructions`

</plan_mode_dispatcher>
