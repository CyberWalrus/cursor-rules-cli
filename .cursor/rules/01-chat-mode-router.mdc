---
id: chat-mode-router
type: compact
alwaysApply: true
---

# Chat Mode Router

<chat_mode_router>

**EXECUTE FIRST - ZERO TOLERANCE:**

Before ANY tool call, check system_reminder for `[MODE_INITIALIZED:` marker:

1. Marker NOT FOUND ‚Üí First response ‚Üí Determine mode by priority (lines 24-29) ‚Üí Announce mode immediately ‚Üí Then execute tools
2. Marker FOUND ‚Üí Extract mode ‚Üí Check if changed (step 3) ‚Üí If unchanged, skip to step 4
3. Mode changed triggers:
   - system_reminder contains "switched from"
   - system_reminder "Plan mode is active" AND marker = `AGENT_MODE` ‚Üí switch to PLAN_MODE
   - system_reminder NO "Plan mode" AND marker = `PLAN_MODE` ‚Üí switch to AGENT_MODE
   - mode_specific_rule appears/changes in system_reminder
4. Execute tools

**MODE PRIORITY (lower = higher):**

1. mode_specific_rule "custom_ask" OR Ask marker ‚Üí ASK_MODE
2. mode_specific_rule (other) ‚Üí OTHER_MODE
3. system_reminder "Plan mode is active" ‚Üí PLAN_MODE
4. Otherwise ‚Üí AGENT_MODE

**ANNOUNCEMENT FORMAT (one line):**

- Standard: `[MODE_INITIALIZED: {MODE_NAME}] ‚Üí üìÑ {relative_path} ‚Üí Reading and strictly following core instructions`
- PLAN_MODE: `[MODE_INITIALIZED: PLAN_MODE] ‚Üí üìÑ .cursor/rules/plan-mode-dispatcher.mdc ‚Üí Reading core instructions now`

**PLAN MODE CRITICAL OUTPUT FORMAT:**

After announcement, PLAN_MODE MUST:

1. Read file via `read_file('.cursor/rules/plan-mode-dispatcher.mdc')` in same batch
2. Output blocking reminder: "‚úÖ –ò–∑—É—á–∏–ª –ø—Ä–∞–≤–∏–ª–∞ –∏–∑ plan-mode-dispatcher.mdc ‚Üí üö´ –ó–ê–ü–†–ï–©–ï–ù–û –ø–∏—Å–∞—Ç—å –ø–ª–∞–Ω –¥–æ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ç–∏–ø–∞ –∑–∞–¥–∞—á–∏ ‚Üí üîç –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É—é —Ç–∏–ø –∑–∞–¥–∞—á–∏"
3. Then classify task type (MANDATORY before plan creation)
Creating plan before classification = VIOLATION.

**Examples:**

- `[MODE_INITIALIZED: PLAN_MODE] ‚Üí üìÑ .cursor/rules/plan-mode-dispatcher.mdc ‚Üí Reading core instructions now`
- `[MODE_INITIALIZED: AGENT_MODE] ‚Üí üìÑ .cursor/rules/07-agent-mode-workflow.mdc ‚Üí Reading and strictly following core instructions (already loaded)`
- `[MODE_INITIALIZED: ASK_MODE] ‚Üí üìÑ .cursor/rules/ask-mode-workflow.mdc ‚Üí Reading and strictly following core instructions`

**After announcement:**

- PLAN MODE: Call `read_file('.cursor/rules/plan-mode-dispatcher.mdc')` in same batch, then output blocking reminder (see PLAN MODE CRITICAL OUTPUT FORMAT step 2)
- ASK MODE: Call `read_file('.cursor/rules/ask-mode-workflow.mdc')` in same batch
- AGENT MODE: No read_file needed (already loaded)

**ZERO TOLERANCE:** PLAN/ASK mode read_file is NON-NEGOTIABLE. "Task is obvious" = WRONG REASONING. read_file MANDATORY even if familiar with content. PLAN MODE blocking reminder output is MANDATORY after reading file.

**SPECIAL CASE - Plan Execution:**

When user approves plan and execution starts:

- **MANDATORY FIRST LINE:** Output `[MODE_INITIALIZED: AGENT_MODE] ‚Üí üìÑ .cursor/rules/07-agent-mode-workflow.mdc ‚Üí Reading and strictly following core instructions (already loaded)` BEFORE any tools
- Then execute todos

**üö® BLOCKING RULES:**

1. NO tool calls before mode announcement (first response)
2. NO text before announcement line
3. NO skipping marker check ("task too simple" = WRONG)
4. System_reminder mode indication ‚â† marker presence ‚Üí ALWAYS check marker FIRST

**‚ö° MOTIVATION:**

- ‚úÖ Correct detection ‚Üí smooth execution, trust
- ‚ùå Skip protocol ‚Üí immediate failure, wasted tokens, rework

**ANTI-SHORTCUTS:**

"Simple task, skip check" ‚Üí WRONG! Complexity irrelevant.
"Faster without announcement" ‚Üí WRONG! Speed without protocol = failure.
"system_reminder shows mode" ‚Üí WRONG! Marker check MANDATORY.

**REALITY CHECK:** 90% violations happen on "simple tasks" where check seemed optional. It's NEVER optional.

**FALLBACK:**

No conditions match ‚Üí DEFAULT to AGENT_MODE ‚Üí announce + marker (no read_file).

<completion_criteria>

- [ ] Mode announced (if first response or changed)
- [ ] Marker output in correct format
- [ ] File loaded (if PLAN/ASK mode)
- [ ] No tools called before announcement
</completion_criteria>

</chat_mode_router>
