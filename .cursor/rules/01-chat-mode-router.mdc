---
id: chat-mode-router
type: compact
alwaysApply: true
---

# Chat Mode Router

<chat_mode_router>

**ABSOLUTE BARRIER - FIRST MESSAGE PROTOCOL:**

Before ANY tool call:

1. Ask yourself: "Have I already responded to the user in this chat?"
   - NO (this is my first response) → announce mode FIRST (MANDATORY, BLOCKING)
   - YES (I already responded before) → proceed to mode change detection
2. FORBIDDEN: Tool execution before mode announcement in first response

**SELF-CHECK (execute before first action):**

Did I announce mode in first message?

- NO → STOP IMMEDIATELY, announce mode FIRST
- YES → proceed with tool call

FORBIDDEN: Tool execution before mode announcement in first message

**EXECUTE BEFORE ANY ACTION:**

1. Ask: "Have I responded in this chat before?"
2. IF NO (first response) → announce mode (MANDATORY)
3. IF YES (subsequent response) → determine current mode from system_reminder
4. IF YES (subsequent response) → check MODE CHANGED triggers
5. IF triggered → announce protocol | OTHERWISE → skip announcement, proceed

**MANDATORY PRE-FLIGHT CHECK (before ANY tool call):**

- [ ] Asked: "Have I responded in this chat before?"
- [ ] If NO → mode announced? (BLOCKING - must be YES before tool call)
- [ ] If YES → mode change check completed?

❌ ANY unchecked → STOP, complete check first

**PROTOCOL (EXECUTE ONLY IF MODE CHANGED):**

1. Output: `→ [MODE] detected`
2. Output: `→ reading .cursor/rules/[file].mdc`
3. Output: `→ Following [file].mdc as primary instructions`
4. Call: `read_file([file].mdc)` in same batch (EXCEPTION: AGENT MODE - skip read_file, file already loaded via alwaysApply)

**ZERO TOLERANCE:** Protocol must run; skipping on mode change causes immediate failure.

**MODE CHANGED triggers:**

1. system_reminder contains "switched from"
2. mode_specific_rule appeared or changed
3. Plan approval detected (phrases: "approved your plan", "implement", "execute plan") AND system_reminder changed from "Plan mode is active"
4. system_reminder mode ≠ previous message mode

**MODE UNCHANGED (subsequent messages only):** Skip announcement, execute task immediately.

**MODE PRIORITY (if mode changed):**

1. mode_specific_rule with "custom_ask" → ASK MODE → read ask-mode-workflow.mdc
2. mode_specific_rule (other) → OTHER MODE → follow rule directly
3. system_reminder "Plan mode is active" → PLAN MODE → read plan-mode-dispatcher.mdc
4. system_reminder Ask marker → ASK MODE → read ask-mode-workflow.mdc
5. Otherwise → AGENT MODE → announce only (07-agent-mode-workflow.mdc already loaded)

**ABSOLUTE REQUIREMENT:**

Before executing ANY tool (read_file, run_terminal_cmd, grep, search_replace, write, codebase_search, list_dir, glob_file_search, etc.):

- First response (never responded before) → MUST announce mode → STOP IMMEDIATELY if not announced
- Subsequent response (already responded) → Verify mode comparison completed → Handle announcement (if changed) or skip (if unchanged)

FORBIDDEN: Tool execution without mode check | Announcement when mode unchanged | Skip announcement when mode changed

VIOLATION CONSEQUENCE: Protocol breach = task failure

**EXAMPLES:**

✅ First message (Agent mode):

```
→ AGENT MODE detected
→ Following 07-agent-mode-workflow.mdc as primary instructions
Читаю файл для анализа...
```

✅ Plan mode (changed):

```
→ PLAN MODE detected
→ reading .cursor/rules/plan-mode-dispatcher.mdc
→ Following plan-mode-dispatcher.mdc as primary instructions
[read_file call]
```

✅ Agent mode (unchanged):

```
Читаю файл для анализа...
[direct task execution]
```

❌ Violation (mode changed):

```
[mode changed but no announcement]
```

❌ Violation (first message):

```
[read_file call without mode announcement]
```

❌ Violation (real case #1):

```
User: "запусти команду линтера и исправь ошибки"
[run_terminal_cmd executed without mode announcement]
```

❌ Violation (real case #2):

```
User: "провалидируй файл"
[read_file + mcp_mcp-validator_validate executed without mode announcement]
```

**Should be:**

```
→ AGENT MODE detected
→ Following 07-agent-mode-workflow.mdc as primary instructions
[read_file executed after announcement]
```

</chat_mode_router>
