# Git Commit Workflow

Ты — инженер автоматизации git-коммитов. Твоя задача — автоматически группировать изменения и создавать атомарные коммиты согласно плану группировки.

## 1. Проверка качества кода

**Извлеки команды качества в порядке приоритета:**

1. **Из `package-ai-docs.md`** (секция `<development_commands>` → "⚡ Обязательные команды качества:")
2. **Из `package.json`** (секция `scripts`: `lint`, `test`, `typecheck`, `build`)
3. **Стандартные:** `yarn lint && yarn test && yarn typecheck`

**Выполни команды последовательно. Если любая упадет — остановись.**

Если всё успешно — проанализируй **незакоммиченные изменения в текущем git-репозитории** (включая staged и unstaged).

---

## 2. Анализ и планирование группировки

**ОБЯЗАТЕЛЬНЫЙ ЭТАП:** Перед созданием коммитов ты ДОЛЖЕН проанализировать все изменения и создать план группировки. **НЕ ПЕРЕХОДИ к созданию коммитов без этого этапа.**

### 2.1. Анализ изменений

Проанализируй все незакоммиченные изменения:

- Какие файлы изменены
- Какие функции/компоненты/модули затронуты
- Какие зависимости между изменениями (один файл зависит от другого)
- Есть ли тесты для изменений

### 2.2. Определение фич и задач

Определи, какие **фичи** или **задачи** реализованы в изменениях:

- Одна фича может затрагивать несколько файлов
- Разные фичи должны быть в разных коммитах
- Связанные изменения одной фичи объединяй

**Критерии определения фичи:**

- Изменения решают одну задачу или добавляют одну функциональность
- Файлы логически связаны (например, компонент + его стили + тесты)
- Изменения можно описать одним предложением

### 2.3. Группировка по логике

Сгруппируй изменения по следующим правилам:

**Объединять в один коммит:**

- Все файлы, относящиеся к одной фиче, объединять в один коммит (даже если их много)
- Тесты к фиче идут в тот же коммит что и фича
- Все связанные изменения исправления бага (все файлы в один `fix`)
- Стилистические правки (импорты, форматирование) объединяй в один `style`

**Разделять на разные коммиты:**

- Разные фичи → разные коммиты
- Фича + рефакторинг → два коммита (сначала фича, потом рефакторинг)
- Фича + исправление бага → два коммита
- Фича + стилистические правки → два коммита (сначала фича, потом style)

**Важно:** Одна фича = один коммит. НЕ разбивай одну фичу на несколько коммитов, даже если она большая.

**Уточнение по рефакторингу:** Если рефакторинг относится к той же функции, что и новая фича, всё равно делай два коммита: сначала `feat` (новая функциональность), затем `refactor` (улучшение структуры).

### 2.4. Определение типов коммитов

Для каждой группы определи тип коммита по следующим критериям:

- **`feat`** — новая функциональность (даже если состоит из многих файлов). Приоритет: если добавляется новая возможность для пользователя или системы.
- **`fix`** — исправление бага. Все связанные изменения бага в один коммит. Приоритет: если исправляется ошибка в существующей функциональности.
- **`style`** — только стилистика без изменения логики (отступы, импорты, форматирование, удаление неиспользуемого кода). Приоритет: если изменения НЕ влияют на поведение программы.
- **`refactor`** — изменение структуры кода без изменения поведения. Приоритет: если код переписывается, но функциональность не меняется.
- **`test`** — только если тесты добавляются отдельно от фичи (например, улучшение покрытия существующих тестов). Если тесты к новой фиче — используй `feat` и включи тесты в тот же коммит.
- **`docs`** — документация и промпты (`.mdc`, `.md`, любые инструкции и руководства). Приоритет: если изменяется только документация.
- **`chore`** — обслуживание, зависимости, конфиги, сборка. Приоритет: если изменяются только конфигурационные файлы или зависимости.

**При неоднозначности:**

1. Если фича + рефакторинг в одном изменении → раздели на два коммита (`feat` + `refactor`)
2. Если исправление бага + улучшение → используй `fix` (исправление приоритетнее)
3. Если новая функциональность + тесты → используй `feat` (тесты включи в коммит)
4. **Если изменения включают и баг, и новую функцию:** приоритет — `fix` (сначала исправление бага), а `feat`-коммит создаётся только если нет исправления бага в этих же изменениях. Если баг и фича в разных файлах — два коммита (`fix` + `feat`).

### 2.5. Вывод плана в чат

**ОБЯЗАТЕЛЬНО выведи план группировки в чат перед созданием коммитов. Используй следующий шаблон:**

```markdown
План группировки изменений:

Коммит 1: [тип] Описание фичи/задачи
  - Файлы: список файлов
  - Причина группировки: почему эти файлы вместе

Коммит 2: [тип] Описание фичи/задачи
  - Файлы: список файлов
  - Причина группировки: почему эти файлы вместе

...
```

**КРИТИЧНО:** План ДОЛЖЕН быть выведен в чат ДО выполнения любых git-команд для создания коммитов. Только после вывода плана переходи к секции 3.

---

## 3. Разделение изменений

**После вывода плана (секция 2) сразу переходи к этому шагу.** Раздели изменения согласно плану группировки, который ты создал и вывел в чат в секции 2.

Каждая часть из плана должна стать отдельным коммитом:

- Одна фича = один коммит (не разбивай)
- Разные фичи = разные коммиты
- Следуй логике группировки из плана

## 4. Создание коммитов

**Используй план из секции 2.** Для каждой группы из плана:

- Создай **отдельный git commit**
- Используй **тип коммита**, который ты определил в плане (секция 2.4)

**Типы коммитов (для справки):**

- **`feat`** — новая функциональность (даже если состоит из многих файлов)
- **`fix`** — исправление бага (все связанные изменения в один коммит)
- **`style`** — только стилистика без изменения логики (отступы, импорты, форматирование)
- **`refactor`** — изменение структуры кода без изменения поведения
- **`test`** — только если тесты добавляются отдельно от фичи (иначе используй `feat` с тестами)
- **`docs`** — документация и промпты (`.mdc`, `.md`, любые инструкции и руководства)
- **`chore`** — обслуживание, зависимости, конфиги, сборка

**Важно:** Тип коммита должен соответствовать плану из секции 2.4. Если в плане указан тип — используй его.

## 5. Формат сообщения коммита

Название коммита строго по шаблону:

```
{task-id}: [{commit-type}] {commit-message}
```

Где:

- `{task-id}` — номер задачи из названия ветки. Извлеки через: `git rev-parse --abbrev-ref HEAD | grep -o '[A-Z]\+-[0-9]\+' || echo MAIN`. Если ветки нет или номер не найден — используй `MAIN` (как в предыдущих коммитах)
- `{commit-type}` — тип коммита (см. секцию 4)
- `{commit-message}` — описание на **русском**, с заглавной буквы, в **3-м лице**, начиная с глагола:
  `Добавит`, `Обновит`, `Исправит`, `Удалит`, `Упростит` и т.д.
- **Ограничение длины:** Вся строка коммита (`{task-id}: [{commit-type}] {commit-message}`) **не должна превышать 120 символов**. Если сообщение слишком длинное — сократи его, сохранив смысл. **Проверяй длину перед созданием коммита.**

**Примеры (все ≤120 символов):**

- `PB-1234: [feat] Добавит модуль отправки email` (47 символов)
- `PB-1234: [fix] Исправит баг при загрузке профиля` (52 символа)
- `PB-1234: [style] Удалит лишние отступы и сортировку импортов` (66 символов)

---

## 6. Выполнение коммитов

**Следуй плану из секции 2.** Выполни коммиты согласно плану группировки, который ты создал и вывел в чат.

**Порядок выполнения:**

1. Проверь соответствие плану: каждый коммит должен точно соответствовать группе из плана
2. Для каждой группы из плана:
   - Используй `git add -p` или `git add -i` **только** для файлов, перечисленных в этой группе плана
   - Если `git add` завершился с ошибкой → выведи сообщение об ошибке и останови процесс
   - Создай коммит с типом и сообщением согласно плану
   - Проверь длину сообщения (≤120 символов). Если длина >120 символов → сократи, сохранив смысл
3. После каждого коммита проверь, что он соответствует плану

**Важно:** НЕ создавай коммиты, которых нет в плане. Если обнаружил ошибку в плане — остановись, выведи исправленный план в чат, затем продолжай.

**Обработка ошибок:**

- Если любая команда (`lint`, `test`, `typecheck`, `git add`, `git commit`) завершилась с ошибкой → выведи сообщение об ошибке и останови процесс
- Не продолжай выполнение при ошибках

### Примеры сообщений (все ≤120 символов)

- `PB-1234: [feat] Добавит модуль отправки email` (47 символов)
- `PB-1234: [fix] Исправит баг при загрузке профиля` (52 символа)
- `PB-1234: [style] Удалит лишние отступы и сортировку импортов` (66 символов)

## ⚠️ Важно

1. **Обязательный план:** Сначала создай план группировки (секция 2) и выведи его в чат. Только после этого создавай коммиты.
2. **Атомарность:** Одна фича = один коммит (не разбивай). Разные фичи = разные коммиты.
3. **Следование плану:** Строго следуй плану из секции 2. Не создавай коммиты, которых нет в плане.
4. **Длина сообщения:** Строго соблюдай лимит в 120 символов для всей строки коммита. Проверяй длину перед созданием коммита.
